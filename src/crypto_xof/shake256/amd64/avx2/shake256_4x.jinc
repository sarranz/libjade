
from Jade require "common/keccak/keccak1600/amd64/avx2/keccakf1600_4x.jinc"
from Jade require "common/keccak/common/fips202_params.jinc" // SHAKE256_RATE

inline fn __shake256_squeezeblock4x(
  reg ptr u256[25] state,
  reg ptr u8[SHAKE256_RATE] h0 h1 h2 h3,
  reg u64 ms)
  ->
  reg ptr u256[25],
  reg ptr u8[SHAKE256_RATE],
  reg ptr u8[SHAKE256_RATE],
  reg ptr u8[SHAKE256_RATE],
  reg ptr u8[SHAKE256_RATE],
  #msf reg u64
{
  reg u256 t256;
  reg u128 t128;
  inline int i;

  stack ptr u8[SHAKE256_RATE] s_h0 s_h1 s_h2 s_h3;
  s_h0 = h0;
  s_h1 = h1;

  state, ms = __keccakf1600_4x_avx2(state, ms);

  h0 = s_h0;
  h0 = #protect_ptr(h0, ms);
  h1 = s_h1;
  h1 = #protect_ptr(h1, ms);

	for i = 0 to (SHAKE256_RATE / 8) {
    t256 = state[i];
    t128 = (128u)t256;
		h0[u64 i] = #VMOVLPD(t128);
		h1[u64 i] = #VMOVHPD(t128);
    t128 = #VEXTRACTI128(t256, 1);
		h2[u64 i] = #VMOVLPD(t128);
		h3[u64 i] = #VMOVHPD(t128);
	}

  return state, h0, h1, h2, h3, ms;
}
